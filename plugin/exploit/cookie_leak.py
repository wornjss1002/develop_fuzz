from typing import Optional, Dict, List
from data_models import FinalReportData, ExploitScenario, IExploitCheck, CookieInfo

class CookieLeak(IExploitCheck):
    def check(self, data: FinalReportData, callback_server: str) -> Optional[ExploitScenario]:
        all_cookies: List[CookieInfo] = data.defenses.all_cookies

        if not all_cookies:
            return None

        leakable_cookies = [c.name for c in all_cookies if not c.httponly]
        protected_cookies = [c.name for c in all_cookies if c.httponly]

        if not leakable_cookies:
            return ExploitScenario(
                scenario_name="쿠키 탈취",
                is_possible=False,
                des=f"모든 쿠키({protected_cookies})에 'HttpOnly' 플래그가 설정되어 있습니다.",
                raw = None,
                poc_code=None
            )
        
        return ExploitScenario(
            scenario_name="쿠키 탈취",
            is_possible=True,
            des=f"'HttpOnly'가 없는 쿠키({leakable_cookies})가 발견되었습니다.",
            raw="document.cookie",
            poc_code=None
        )